const { ipcRenderer } = require('electron');

let isOn = false;
let isExpanded = false;
let selectedLanguage = 'en';
let lastAnalysisData = null;

const body = document.body;
const launcherBtn = document.getElementById('launcher');
const collapseBtn = document.getElementById('collapse');
const panel = document.getElementById('panel');
const toggleBtn = document.getElementById('toggle');
const resultDiv = document.getElementById('result');
const languageSelect = document.getElementById('language-select');
const languageLabel = document.querySelector('label[for="language-select"]');

const LANGUAGE_OPTIONS = [
  { code: 'en', label: 'English' },
  { code: 'as', label: 'Assamese (???????)' },
  { code: 'bn', label: 'Bengali (?????)' },
  { code: 'brx', label: 'Bodo (????)' },
  { code: 'doi', label: 'Dogri (?????)' },
  { code: 'gu', label: 'Gujarati (???????)' },
  { code: 'hi', label: 'Hindi (??????)' },
  { code: 'kn', label: 'Kannada (?????)' },
  { code: 'ks', label: 'Kashmiri (?????)' },
  { code: 'gom', label: 'Konkani (??????)' },
  { code: 'mai', label: 'Maithili (??????)' },
  { code: 'ml', label: 'Malayalam (??????)' },
  { code: 'mni', label: 'Manipuri (???????)' },
  { code: 'mr', label: 'Marathi (?????)' },
  { code: 'ne', label: 'Nepali (??????)' },
  { code: 'or', label: 'Odia (?????)' },
  { code: 'pa', label: 'Punjabi (??????)' },
  { code: 'sa', label: 'Sanskrit (?????????)' },
  { code: 'sat', label: 'Santali (???????)' },
  { code: 'sd', label: 'Sindhi (????)' },
  { code: 'ta', label: 'Tamil (?????)' },
  { code: 'te', label: 'Telugu (??????)' },
  { code: 'ur', label: 'Urdu (????)' }
];

const I18N = {
  en: {
    displayLanguage: 'Display Language',
    threatLevel: 'Threat Level',
    threatScore: 'Threat Score',
    scannedBlocks: 'Scanned Blocks',
    detectedLanguage: 'Detected Language',
    manipulationRadar: 'Manipulation Radar',
    technicalIndicators: 'Technical Indicators',
    suspiciousDomains: 'Suspicious Domains',
    noneDetected: 'None detected',
    analyzing: 'Analyzing...',
    backendOffline: 'Backend not running!',
    unknown: 'Unknown',
    levels: {
      LOW: 'LOW',
      MEDIUM: 'MEDIUM',
      HIGH: 'HIGH',
      CRITICAL: 'CRITICAL',
      SAFE: 'SAFE',
      SUSPICIOUS: 'SUSPICIOUS',
      HIGH_RISK: 'HIGH RISK',
      UNKNOWN: 'UNKNOWN'
    },
    languageNames: { English: 'English', Unknown: 'Unknown' }
  },
  as: {
    displayLanguage: '???????? ????', threatLevel: '?????? ????', threatScore: '?????? ?????', scannedBlocks: '????? ??? ????????', detectedLanguage: '??????? ????', manipulationRadar: '?????????? ?????', technicalIndicators: '??????? ????', suspiciousDomains: '????????? ?????', noneDetected: '???? ??? ??? ???', analyzing: '???????? ??? ???...', backendOffline: '??????? ??? ??? ???!', unknown: '??????',
    levels: { LOW: '??', MEDIUM: '?????', HIGH: '????', CRITICAL: '??????', SAFE: '??????', SUSPICIOUS: '?????????', HIGH_RISK: '???? ?????', UNKNOWN: '??????' },
    languageNames: { English: '??????', Unknown: '??????' }
  },
  bn: {
    displayLanguage: '?????????? ????', threatLevel: '?????? ????', threatScore: '?????? ?????', scannedBlocks: '??????? ??? ????', detectedLanguage: '?????? ????', manipulationRadar: '???????? ?????', technicalIndicators: '??????????? ????', suspiciousDomains: '????????? ?????', noneDetected: '???? ??? ??????', analyzing: '???????? ????...', backendOffline: '????????? ???? ???!', unknown: '?????',
    levels: { LOW: '??', MEDIUM: '??????', HIGH: '????', CRITICAL: '??????', SAFE: '??????', SUSPICIOUS: '?????????', HIGH_RISK: '???? ?????', UNKNOWN: '?????' },
    languageNames: { English: '??????', Unknown: '?????' }
  },
  brx: {
    displayLanguage: 'Display Language', threatLevel: 'Threat Level', threatScore: 'Threat Score', scannedBlocks: 'Scanned Blocks', detectedLanguage: 'Detected Language', manipulationRadar: 'Manipulation Radar', technicalIndicators: 'Technical Indicators', suspiciousDomains: 'Suspicious Domains', noneDetected: 'None detected', analyzing: 'Analyzing...', backendOffline: 'Backend not running!', unknown: 'Unknown',
    levels: { LOW: 'LOW', MEDIUM: 'MEDIUM', HIGH: 'HIGH', CRITICAL: 'CRITICAL', SAFE: 'SAFE', SUSPICIOUS: 'SUSPICIOUS', HIGH_RISK: 'HIGH RISK', UNKNOWN: 'UNKNOWN' },
    languageNames: { English: 'English', Unknown: 'Unknown' }
  },
  doi: {
    displayLanguage: '??????? ????', threatLevel: '???? ?? ????', threatScore: '???? ?? ?????', scannedBlocks: '????? ???? ?????', detectedLanguage: '????? ?? ????', manipulationRadar: '?????????? ????', technicalIndicators: '?????? ??????', suspiciousDomains: '??????? ?????', noneDetected: '????? ?? ???? ??????', analyzing: '???????? ?? ??? ?...', backendOffline: '?????? ???? ?? ???!', unknown: '??????',
    levels: { LOW: '????', MEDIUM: '?????', HIGH: '????', CRITICAL: '?????', SAFE: '????????', SUSPICIOUS: '???????', HIGH_RISK: '???? ?????', UNKNOWN: '??????' },
    languageNames: { English: '?????????', Unknown: '??????' }
  },
  gu: {
    displayLanguage: '????????? ????', threatLevel: '???? ????', threatScore: '???? ?????', scannedBlocks: '????? ????? ?????', detectedLanguage: '???????? ????', manipulationRadar: '???????????? ????', technicalIndicators: '???????? ?????', suspiciousDomains: '???????? ?????', noneDetected: '?? ?????? ???', analyzing: '???????? ???? ?????? ??...', backendOffline: '??????? ???? ???!', unknown: '??????',
    levels: { LOW: '?????', MEDIUM: '?????', HIGH: '????', CRITICAL: '?????', SAFE: '????????', SUSPICIOUS: '????????', HIGH_RISK: '???? ????', UNKNOWN: '??????' },
    languageNames: { English: '????????', Unknown: '??????' }
  },
  hi: {
    displayLanguage: '????????? ????', threatLevel: '???? ?? ????', threatScore: '???? ?? ?????', scannedBlocks: '????? ??? ?? ?????', detectedLanguage: '?????? ?? ????', manipulationRadar: '?????????? ????', technicalIndicators: '?????? ??????', suspiciousDomains: '??????? ?????', noneDetected: '??? ???? ????', analyzing: '???????? ???? ??...', backendOffline: '?????? ???? ???? ??!', unknown: '??????',
    levels: { LOW: '?????', MEDIUM: '?????', HIGH: '????', CRITICAL: '?????', SAFE: '????????', SUSPICIOUS: '???????', HIGH_RISK: '???? ?????', UNKNOWN: '??????' },
    languageNames: { English: '?????????', Unknown: '??????' }
  },
  kn: {
    displayLanguage: '???????? ????', threatLevel: '???? ????', threatScore: '???? ???', scannedBlocks: '???????? ????? ??????????', detectedLanguage: '????????? ????', manipulationRadar: '??????????????? ??????', technicalIndicators: '???????? ??????', suspiciousDomains: '?????????? ??????????', noneDetected: '?????? ????????????', analyzing: '???????????????????...', backendOffline: '??????????? ?????????????!', unknown: '???????',
    levels: { LOW: '?????', MEDIUM: '?????', HIGH: '??????', CRITICAL: '?????', SAFE: '????????', SUSPICIOUS: '??????????', HIGH_RISK: '??????? ????', UNKNOWN: '???????' },
    languageNames: { English: '????????', Unknown: '???????' }
  },
  ks: {
    displayLanguage: '???????? ????', threatLevel: '???? ?? ????', threatScore: '???? ?? ?????', scannedBlocks: '????? ?????', detectedLanguage: '?????? ?? ????', manipulationRadar: '?????????? ????', technicalIndicators: '?????? ??????', suspiciousDomains: '??????? ?????', noneDetected: '??? ???? ????', analyzing: '???????? ???? ??...', backendOffline: '?????? ???? ???? ??!', unknown: '??????',
    levels: { LOW: '??', MEDIUM: '?????', HIGH: '????', CRITICAL: '?????', SAFE: '????????', SUSPICIOUS: '???????', HIGH_RISK: '???? ?????', UNKNOWN: '??????' },
    languageNames: { English: '?????????', Unknown: '??????' }
  },
  gom: {
    displayLanguage: '???????? ???', threatLevel: '???????? ????', threatScore: '???????? ?????', scannedBlocks: '????? ?????? ???????', detectedLanguage: '??????? ???', manipulationRadar: '???????????? ????', technicalIndicators: '???????? ???????', suspiciousDomains: '?????? ???????', noneDetected: '?????? ?????? ??', analyzing: '???????? ????? ???...', backendOffline: '?????? ???? ??!', unknown: '??????',
    levels: { LOW: '???', MEDIUM: '?????', HIGH: '????', CRITICAL: '?????', SAFE: '????????', SUSPICIOUS: '??????', HIGH_RISK: '???? ????', UNKNOWN: '??????' },
    languageNames: { English: '???????', Unknown: '??????' }
  },
  mai: {
    displayLanguage: '????????? ????', threatLevel: '???? ????', threatScore: '???? ?????', scannedBlocks: '????? ??? ?????', detectedLanguage: '??????? ????', manipulationRadar: '?????????? ????', technicalIndicators: '?????? ?????', suspiciousDomains: '??????? ?????', noneDetected: '???? ??? ????', analyzing: '???????? ??? ??? ???...', backendOffline: '?????? ??? ??? ??? ???!', unknown: '??????',
    levels: { LOW: '??', MEDIUM: '?????', HIGH: '????', CRITICAL: '?????', SAFE: '????????', SUSPICIOUS: '???????', HIGH_RISK: '???? ?????', UNKNOWN: '??????' },
    languageNames: { English: '????????', Unknown: '??????' }
  },
  ml: {
    displayLanguage: '??????? ???', threatLevel: '????? ???', threatScore: '????? ?????', scannedBlocks: '????? ????? ??????????', detectedLanguage: '?????????? ???', manipulationRadar: '???????????? ????', technicalIndicators: '????????? ???????', suspiciousDomains: '????????? ???????????', noneDetected: '?????? ??????????????', analyzing: '??????? ??????????...', backendOffline: '??????????? ????????????????????!', unknown: '???????',
    levels: { LOW: '?????', MEDIUM: '???????', HIGH: '??????', CRITICAL: '???????', SAFE: '?????????', SUSPICIOUS: '??????????', HIGH_RISK: '?????? ?????', UNKNOWN: '???????' },
    languageNames: { English: '????????', Unknown: '???????' }
  },
  mni: {
    displayLanguage: '??????? ???', threatLevel: '????? ?????', threatScore: '????? ?????', scannedBlocks: '????? ???? ?????', detectedLanguage: '???? ???', manipulationRadar: '?????????? ?????', technicalIndicators: '???????? ????????', suspiciousDomains: '????? ?????', noneDetected: '??? ????', analyzing: '???????? ????...', backendOffline: '??????? ??????!', unknown: '?????',
    levels: { LOW: '???', MEDIUM: '???', HIGH: '?????', CRITICAL: '?????????', SAFE: '???', SUSPICIOUS: '?????', HIGH_RISK: '????? ?????', UNKNOWN: '?????' },
    languageNames: { English: '?????', Unknown: '?????' }
  },
  mr: {
    displayLanguage: '???????????? ????', threatLevel: '???????? ?????', threatScore: '???? ???', scannedBlocks: '????? ?????? ???????', detectedLanguage: '??????? ????', manipulationRadar: '???????????? ????', technicalIndicators: '???????? ??????????', suspiciousDomains: '????????? ???????', noneDetected: '???? ????? ????', analyzing: '???????? ???? ???...', backendOffline: '?????? ???? ????!', unknown: '??????',
    levels: { LOW: '???', MEDIUM: '?????', HIGH: '????', CRITICAL: '?????', SAFE: '????????', SUSPICIOUS: '?????????', HIGH_RISK: '???? ?????', UNKNOWN: '??????' },
    languageNames: { English: '???????', Unknown: '??????' }
  },
  ne: {
    displayLanguage: '???????? ????', threatLevel: '???? ????', threatScore: '???? ?????', scannedBlocks: '??????? ?????? ????', detectedLanguage: '?????? ?????? ????', manipulationRadar: '???????????? ????', technicalIndicators: '????????? ????', suspiciousDomains: '???????? ?????', noneDetected: '???? ??????', analyzing: '???????? ??????? ?...', backendOffline: '????????? ???????? ???!', unknown: '??????',
    levels: { LOW: '??', MEDIUM: '?????', HIGH: '????', CRITICAL: '??????', SAFE: '????????', SUSPICIOUS: '????????', HIGH_RISK: '???? ?????', UNKNOWN: '??????' },
    languageNames: { English: '????????', Unknown: '??????' }
  },
  or: {
    displayLanguage: '??????????? ????', threatLevel: '????? ????', threatScore: '????? ?????', scannedBlocks: '?????? ??? ?????', detectedLanguage: '?????? ????', manipulationRadar: '????????????? ?????', technicalIndicators: '?????? ????', suspiciousDomains: '????????? ?????', noneDetected: '???? ?????? ?????', analyzing: '???????? ??????...', backendOffline: '????????? ???? ?????!', unknown: '??????',
    levels: { LOW: '?????', MEDIUM: '?????', HIGH: '????', CRITICAL: '??????', SAFE: '????????', SUSPICIOUS: '?????????', HIGH_RISK: '???? ?????', UNKNOWN: '??????' },
    languageNames: { English: '??????', Unknown: '??????' }
  },
  pa: {
    displayLanguage: '?????? ???? ?????', threatLevel: '???? ?? ????', threatScore: '???? ?? ????', scannedBlocks: '???? ???? ????', detectedLanguage: '????? ?????', manipulationRadar: '??????????? ????', technicalIndicators: '?????? ??????', suspiciousDomains: '????? ?????', noneDetected: '??? ???? ?????', analyzing: '????????? ??? ???? ??...', backendOffline: '?????? ???? ??? ????!', unknown: '?????',
    levels: { LOW: '???', MEDIUM: '???????', HIGH: '???', CRITICAL: '?????', SAFE: '????????', SUSPICIOUS: '?????', HIGH_RISK: '??? ????', UNKNOWN: '?????' },
    languageNames: { English: '????????', Unknown: '?????' }
  },
  sa: {
    displayLanguage: '????????????', threatLevel: '???????', threatScore: '???????', scannedBlocks: '?????????? ??????', detectedLanguage: '?????????????', manipulationRadar: '?????????? ????', technicalIndicators: '????????????', suspiciousDomains: '??????? ??????', noneDetected: '????? ? ???????', analyzing: '????????? ???? ?????...', backendOffline: '??????? ? ????!', unknown: '????????',
    levels: { LOW: '?????', MEDIUM: '?????', HIGH: '????', CRITICAL: '??????', SAFE: '????????', SUSPICIOUS: '???????', HIGH_RISK: '????????', UNKNOWN: '????????' },
    languageNames: { English: '??????????', Unknown: '????????' }
  },
  sat: {
    displayLanguage: 'Display Language', threatLevel: 'Threat Level', threatScore: 'Threat Score', scannedBlocks: 'Scanned Blocks', detectedLanguage: 'Detected Language', manipulationRadar: 'Manipulation Radar', technicalIndicators: 'Technical Indicators', suspiciousDomains: 'Suspicious Domains', noneDetected: 'None detected', analyzing: 'Analyzing...', backendOffline: 'Backend not running!', unknown: 'Unknown',
    levels: { LOW: 'LOW', MEDIUM: 'MEDIUM', HIGH: 'HIGH', CRITICAL: 'CRITICAL', SAFE: 'SAFE', SUSPICIOUS: 'SUSPICIOUS', HIGH_RISK: 'HIGH RISK', UNKNOWN: 'UNKNOWN' },
    languageNames: { English: 'English', Unknown: 'Unknown' }
  },
  sd: {
    displayLanguage: '?????? ?? ????', threatLevel: '???? ?? ???', threatScore: '???? ?? ?????', scannedBlocks: '????? ??? ?????', detectedLanguage: '????? ??? ????', manipulationRadar: '????????? ?????', technicalIndicators: '??????? ?????', suspiciousDomains: '??? ?????', noneDetected: '??? ?? ?? ????', analyzing: '????? ???? ???...', backendOffline: '??? ???? ??? ?? ???? ???!', unknown: '??????',
    levels: { LOW: '???', MEDIUM: '?????', HIGH: '????', CRITICAL: '???', SAFE: '?????', SUSPICIOUS: '???', HIGH_RISK: '???? ????', UNKNOWN: '??????' },
    languageNames: { English: '???????', Unknown: '??????' }
  },
  ta: {
    displayLanguage: '?????? ????', threatLevel: '???? ????', threatScore: '???? ?????????', scannedBlocks: '?????? ??????????? ????????', detectedLanguage: '????????????? ????', manipulationRadar: '?????? ??????', technicalIndicators: '??????????? ???????????', suspiciousDomains: '????????????? ?????????', noneDetected: '??????? ?????????????????', analyzing: '??????????? ????????????...', backendOffline: '???????? ???????????!', unknown: '??????????????',
    levels: { LOW: '??????', MEDIUM: '?????????', HIGH: '????', CRITICAL: '??????? ???????', SAFE: '???????????', SUSPICIOUS: '?????????', HIGH_RISK: '???? ??????', UNKNOWN: '??????????????' },
    languageNames: { English: '????????', Unknown: '??????????????' }
  },
  te: {
    displayLanguage: '???????? ???', threatLevel: '?????? ??????', threatScore: '?????? ??????', scannedBlocks: '?????? ????? ?????????', detectedLanguage: '?????????? ???', manipulationRadar: '????????????? ??????', technicalIndicators: '???????? ???????', suspiciousDomains: '??????????? ?????????', noneDetected: '??? ??????????????', analyzing: '???????? ??????????...', backendOffline: '????????? ????? ????!', unknown: '???????',
    levels: { LOW: '??????', MEDIUM: '???????', HIGH: '????', CRITICAL: '????????', SAFE: '?????????', SUSPICIOUS: '????????????', HIGH_RISK: '???? ??????', UNKNOWN: '???????' },
    languageNames: { English: '??????', Unknown: '???????' }
  },
  ur: {
    displayLanguage: '????? ?? ????', threatLevel: '???? ?? ???', threatScore: '???? ?? ?????', scannedBlocks: '????? ??? ?????', detectedLanguage: '????? ??? ????', manipulationRadar: '????????? ?????', technicalIndicators: '?????? ?????', suspiciousDomains: '????? ??????', noneDetected: '??? ??? ???? ???', analyzing: '????? ???? ??...', backendOffline: '??? ???? ?? ???? ???!', unknown: '???????',
    levels: { LOW: '??', MEDIUM: '???????', HIGH: '?????', CRITICAL: '?????', SAFE: '?????', SUSPICIOUS: '?????', HIGH_RISK: '????? ????', UNKNOWN: '???????' },
    languageNames: { English: '???????', Unknown: '???????' }
  }
};

const DETECTED_LANGUAGE_LOOKUP = {
  english: 'English',
  assamese: 'Assamese',
  bengali: 'Bengali',
  bodo: 'Bodo',
  dogri: 'Dogri',
  gujarati: 'Gujarati',
  hindi: 'Hindi',
  kannada: 'Kannada',
  kashmiri: 'Kashmiri',
  konkani: 'Konkani',
  maithili: 'Maithili',
  malayalam: 'Malayalam',
  manipuri: 'Manipuri',
  marathi: 'Marathi',
  nepali: 'Nepali',
  odia: 'Odia',
  punjabi: 'Punjabi',
  sanskrit: 'Sanskrit',
  santali: 'Santali',
  sindhi: 'Sindhi',
  tamil: 'Tamil',
  telugu: 'Telugu',
  urdu: 'Urdu',
  unknown: 'Unknown'
};

function translation() {
  return I18N[selectedLanguage] || I18N.en;
}

function t(key) {
  const current = translation();
  return current[key] || I18N.en[key] || key;
}

function populateLanguageSelector() {
  for (const option of LANGUAGE_OPTIONS) {
    const element = document.createElement('option');
    element.value = option.code;
    element.textContent = option.label;
    if (option.code === 'en') {
      element.selected = true;
    }
    languageSelect.appendChild(element);
  }

  languageSelect.addEventListener('change', () => {
    selectedLanguage = languageSelect.value;
    languageLabel.textContent = t('displayLanguage');

    if (lastAnalysisData) {
      renderAnalysis(lastAnalysisData);
    }
  });
}

function normalizeText(value) {
  return String(value || '').trim().toLowerCase().replace(/[_\s-]+/g, ' ');
}

function escapeHtml(value) {
  return String(value)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function inferThreatLevel(data) {
  if (!data || typeof data !== 'object') return 'UNKNOWN';

  if (typeof data.severity === 'string' && data.severity.trim()) {
    return data.severity.toUpperCase();
  }

  if (typeof data.overall_risk === 'number') {
    const score = data.overall_risk;
    if (score < 30) return 'LOW';
    if (score < 60) return 'MEDIUM';
    if (score < 85) return 'HIGH';
    return 'CRITICAL';
  }

  if (typeof data.risk_score === 'number') {
    const score = data.risk_score <= 1 ? data.risk_score * 100 : data.risk_score;
    if (score <= 30) return 'SAFE';
    if (score <= 55) return 'SUSPICIOUS';
    if (score <= 80) return 'HIGH RISK';
    return 'CRITICAL';
  }

  if (typeof data.risk_level === 'string' && data.risk_level.trim()) {
    return data.risk_level.toUpperCase();
  }

  if (typeof data.result === 'string' && data.result.trim()) {
    return data.result.toUpperCase();
  }

  return 'UNKNOWN';
}

function inferThreatScore(data) {
  if (!data || typeof data !== 'object') return 0;
  if (typeof data.threat_score === 'number') return Math.max(0, Math.min(100, Math.round(data.threat_score)));
  if (typeof data.overall_risk === 'number') return Math.max(0, Math.min(100, Math.round(data.overall_risk)));
  if (typeof data.risk_score === 'number') {
    const score = data.risk_score <= 1 ? data.risk_score * 100 : data.risk_score;
    return Math.max(0, Math.min(100, Math.round(score)));
  }
  return 0;
}

function translateThreatLevel(rawThreatLevel) {
  const key = String(rawThreatLevel || 'UNKNOWN').trim().toUpperCase().replace(/\s+/g, '_');
  const levels = translation().levels || I18N.en.levels;
  return levels[key] || rawThreatLevel;
}

function translateDetectedLanguage(rawLanguage) {
  const normalized = normalizeText(rawLanguage);
  const canonical = DETECTED_LANGUAGE_LOOKUP[normalized];
  if (!canonical) return rawLanguage;

  const names = translation().languageNames || {};
  if (canonical === 'English') {
    return names.English || I18N.en.languageNames.English;
  }
  if (canonical === 'Unknown') {
    return names.Unknown || I18N.en.languageNames.Unknown;
  }
  return canonical;
}

function renderAnalysis(data) {
  lastAnalysisData = data;

  const threatLevel = inferThreatLevel(data);
  const threatScore = inferThreatScore(data);
  const scannedBlocks = typeof data.scanned_blocks === 'number' ? data.scanned_blocks : 1;
  const detectedLanguageRaw = (data.detected_language || t('unknown')).toString();
  const detectedLanguage = translateDetectedLanguage(detectedLanguageRaw);

  const manipulationRadars = Array.isArray(data.manipulation_radars) ? data.manipulation_radars : [];
  const technicalIndicators = Array.isArray(data.technical_indicators) ? data.technical_indicators : [];
  const suspiciousDomains = Array.isArray(data.suspicious_domains) ? data.suspicious_domains : [];

  const manipulationText = manipulationRadars.length ? manipulationRadars.map(escapeHtml).join(', ') : t('noneDetected');
  const technicalText = technicalIndicators.length ? technicalIndicators.map(escapeHtml).join(', ') : t('noneDetected');
  const domainsText = suspiciousDomains.length ? suspiciousDomains.map(escapeHtml).join(', ') : t('noneDetected');

  resultDiv.innerHTML = `
    <div><strong>${escapeHtml(t('threatLevel'))}:</strong> ${escapeHtml(translateThreatLevel(threatLevel))}</div>
    <div><strong>${escapeHtml(t('threatScore'))}:</strong> ${threatScore}/100</div>
    <div><strong>${escapeHtml(t('scannedBlocks'))}:</strong> ${scannedBlocks}</div>
    <div><strong>${escapeHtml(t('detectedLanguage'))}:</strong> ${escapeHtml(detectedLanguage)}</div>
    <div style="margin-top:8px;"><strong>${escapeHtml(t('manipulationRadar'))}:</strong> ${manipulationText}</div>
    <div style="margin-top:6px;"><strong>${escapeHtml(t('technicalIndicators'))}:</strong> ${technicalText}</div>
    <div style="margin-top:6px;"><strong>${escapeHtml(t('suspiciousDomains'))}:</strong> ${domainsText}</div>
  `;
}

function setExpandedState(nextState) {
  isExpanded = nextState;
  body.classList.toggle('expanded', isExpanded);
  launcherBtn.style.display = isExpanded ? 'none' : 'block';
  panel.style.display = isExpanded ? 'block' : 'none';
  ipcRenderer.send('set-window-state', isExpanded);
}

launcherBtn.addEventListener('click', () => {
  setExpandedState(true);
});

collapseBtn.addEventListener('click', () => {
  setExpandedState(false);
});

toggleBtn.addEventListener('click', () => {
  isOn = !isOn;
  toggleBtn.innerText = isOn ? 'ON' : 'OFF';
  toggleBtn.style.background = isOn ? 'green' : 'red';
});

ipcRenderer.on('analyze-text', async (event, text) => {
  if (!isOn || !text) return;

  resultDiv.innerText = t('analyzing');
  const API_BASE = (process.env.SURAKSHA_API_URL || 'https://asphales-fork-repo.onrender.com').replace(/\/$/, '');

  try {
    const payload = JSON.stringify({ text: text });
    const headers = { 'Content-Type': 'application/json' };

    let response = await fetch(`${API_BASE}/analyze`, {
      method: 'POST',
      headers: headers,
      body: payload
    });

    if (response.status === 404) {
      response = await fetch(`${API_BASE}/analyze_text`, {
        method: 'POST',
        headers: headers,
        body: payload
      });
    }

    if (!response.ok) {
      throw new Error('Backend error: ' + response.status);
    }

    const data = await response.json();
    renderAnalysis(data);
  } catch (err) {
    resultDiv.innerText = t('backendOffline');
  }
});

window.addEventListener('keydown', (event) => {
  if (event.key === 'Escape' && isExpanded) {
    setExpandedState(false);
  }
});

populateLanguageSelector();
languageLabel.textContent = t('displayLanguage');
setExpandedState(false);
